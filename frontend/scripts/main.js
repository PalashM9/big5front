let patientStatements=[],currentIndex=0,userName=localStorage.getItem("current_user")||"",patientReadStartTime=null,questionOpenTime=null;function shuffleArray(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}async function setUserName(){if(userName=document.getElementById("name").value,!userName)return void alert("Please enter your name");localStorage.setItem("current_user",userName);const e=document.getElementById("welcomeScreen");e.classList.add("fade-out"),setTimeout((()=>{e.classList.add("hidden"),showFakeLoadingSteps(userName,(async()=>{await fetch("https://big5-wish.onrender.com/set_user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:userName})}),document.getElementById("mainSurvey").classList.remove("hidden"),loadPatientStatements()}))}),500)}function showFakeLoadingSteps(e,t){const n=[`Initializing Session For ${e}...`,"Fetching Topic Modules...","Loading User Statements...","Finalizing Interface..."],s=document.getElementById("stepMessages"),o=document.getElementById("fakeLoader");document.getElementById("loader").classList.add("hidden"),o.classList.remove("hidden");let a=0;s.innerHTML="",function e(){if(a>0&&(s.children[a-1].innerHTML=`âœ… ${n[a-1]}`),a<n.length){const t=document.createElement("div");t.innerHTML=`ðŸ”„ ${n[a]}`,s.appendChild(t),a++,setTimeout(e,1200)}else o.classList.add("fade-out"),setTimeout((()=>{o.classList.add("hidden"),t()}),1e3)}()}async function loadPatientStatements(){const e=await fetch("https://big5-wish.onrender.com/get_patient_statements"),t=await e.json();patientStatements=t.patient_statements,shuffleArray(patientStatements),document.getElementById("notif-one").classList.remove("hidden"),document.getElementById("notif-two").classList.remove("hidden"),document.getElementById("totalQuestions").textContent=patientStatements.length,updateStatement()}function updateStatement(){document.getElementById("loader").classList.add("hidden"),currentIndex<patientStatements.length?(document.getElementById("patientSkeleton").classList.remove("hidden"),document.getElementById("categorySkeleton").classList.remove("hidden"),document.getElementById("questionSkeleton").classList.remove("hidden"),document.getElementById("patientStatement").classList.add("hidden"),document.getElementById("categoryLabel").classList.add("hidden"),document.getElementById("category").classList.add("hidden"),document.getElementById("questionLabel").classList.add("hidden"),document.getElementById("question").classList.add("hidden"),setTimeout((()=>{document.getElementById("patientSkeleton").classList.add("hidden"),document.getElementById("patientStatement").classList.remove("hidden"),document.getElementById("patientStatement").textContent=patientStatements[currentIndex],document.getElementById("progressCount").textContent=currentIndex+1,patientReadStartTime=new Date,fetchCategories()}),300)):(document.getElementById("mainSurvey").classList.add("hidden"),document.getElementById("thankYou").classList.remove("hidden"))}async function fetchCategories(){const e=await fetch("https://big5-wish.onrender.com/get_categories",{method:"POST"}),t=await e.json(),n=document.getElementById("category");n.innerHTML='<option value="">Select a topic</option>',t.categories.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t)})),setTimeout((()=>{document.getElementById("categorySkeleton").classList.add("hidden"),document.getElementById("categoryLabel").classList.remove("hidden"),n.classList.remove("hidden")}),1500)}async function fetchQuestions(){const e=document.getElementById("category").value;if(!e)return;document.getElementById("questionSkeleton").classList.remove("hidden"),document.getElementById("question").classList.add("hidden"),document.getElementById("questionLabel").classList.add("hidden");const t=await fetch("https://big5-wish.onrender.com/get_questions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:e})}),n=await t.json(),s=document.getElementById("question");s.innerHTML='<option value="">Select a question</option><option value="not_sure">I am not sure</option>',shuffleArray(n.questions),n.questions.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)})),setTimeout((()=>{document.getElementById("questionSkeleton").classList.add("hidden"),document.getElementById("questionLabel").classList.remove("hidden"),s.classList.remove("hidden")}),1500)}async function submitResponse(){const e=document.getElementById("category").value,t=document.getElementById("question").value,n=localStorage.getItem("current_user"),s=document.getElementById("feedback").value||"";if(!n)return void alert("User name is missing! Please refresh and re-enter your name.");if(!e||!t)return void alert("Please select a category and a question before proceeding.");let o=0;patientReadStartTime&&(o=(new Date-patientReadStartTime)/1e3,localStorage.setItem("read_to_response_time",o.toFixed(2)),patientReadStartTime=null);const a=localStorage.getItem("question_selection_time")||"",d=await fetch("https://big5-wish.onrender.com/submit_response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,patient_statement:patientStatements[currentIndex],category:e,selected_question:t,dropdown_time:a,response_time:o.toFixed(2),feedback:s})}),i=await d.json();i.success?(currentIndex++,updateStatement(),document.getElementById("feedback").value=""):alert("Error submitting response: "+i.message)}const questionDropdown=document.getElementById("question");questionDropdown.addEventListener("mousedown",(()=>{questionOpenTime=new Date})),questionDropdown.addEventListener("change",(()=>{if(questionOpenTime){const e=(new Date-questionOpenTime)/1e3;localStorage.setItem("question_selection_time",e.toFixed(2)),questionOpenTime=null}}));